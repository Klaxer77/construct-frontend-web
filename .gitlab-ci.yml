stages:
  - deploy

deploy_prod:
  stage: deploy
  tags:
    - prod
  script:
    - docker compose -f docker-compose.prod.yml build
    - docker compose -f docker-compose.prod.yml down
    - docker compose -f docker-compose.prod.yml up -d

    - |
      echo "Startup failed. Checking for unhealthy containers..."
      unhealthy=$(docker ps --filter "health=unhealthy" --format "{{.Names}}")
      if [ -z "$unhealthy" ]; then
          echo "No unhealthy containers found."
      else
          echo "Unhealthy containers detected: $unhealthy"
          for container in $unhealthy; do
              echo "Logs for $container:"
              docker logs "$container"
          done
      fi

      errored=$(docker ps -a --filter "status=exited" --format "{{.Names}}")
      if [ -z "$errored" ]; then
          echo "No errored containers found."
      else
          echo "Errored containers detected: $errored"
          for container in $errored; do
              echo "Logs for $container:"
              docker logs "$container"
          done
      fi
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
